name: Expose API via Cloudflare Tunnel (TOKENÂ mode)

on:
  schedule:
    # æ¯ 5Â å°æ—¶åˆ·æ–°ä¸€æ¬¡ï¼ˆUTC 0â€†/â€†5â€†/â€†10â€†/â€†15â€†/â€†20ï¼‰
    - cron: '0 */5 * * *'
  workflow_dispatch:

concurrency:
  group: cloudflareâ€‘tunnel
  cancel-in-progress: true

jobs:
  expose-api:
    runs-on: ubuntu-latest

    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. æ‹‰ä»“åº“ & Python â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Python deps
      run: |
        python -m pip install -U pip
        pip install fastapi uvicorn python-multipart

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. å¯åŠ¨ FastAPI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Start API server (FastAPI)
      run: |
        cd main
        nohup uvicorn src.api.file_hash_api:app \
              --host 0.0.0.0 --port 8000 --log-level info &

        echo "â³Â Waiting for API to come upâ€¦"
        for i in {1..10}; do
          if curl -s http://localhost:8000/ | grep -q æ–‡ä»¶å“ˆå¸Œè®¡ç®—æœåŠ¡API; then
            echo "âœ…Â Local API is healthy"; break
          fi
          sleep 3
          if [ $i -eq 10 ]; then
            echo "âŒÂ API failed to start"; exit 1
          fi
        done

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. cloudflared â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Install cloudflared
      run: |
        wget -qO cloudflared \
          https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared
        sudo mv cloudflared /usr/local/bin/

    - name: Run Cloudflare Tunnel (TOKEN mode)
      env:
        RAW_TOKEN: ${{ secrets.CF_TUNNEL_TOKEN }}
      run: |
        # æ¸…ç†æ¢è¡Œï¼ç©ºæ ¼ï¼Œé¿å… â€œhelp pageâ€ é”™è¯¯
        TOKEN=$(echo "$RAW_TOKEN" | tr -d '\n\r' | xargs)
        [ -z "$TOKEN" ] && { echo "âŒÂ CF_TUNNEL_TOKEN is empty"; exit 1; }

        nohup cloudflared tunnel run --no-autoupdate \
              --token "$TOKEN" > cloudflared.log 2>&1 &

        echo "â³Â Waiting for tunnel to establishâ€¦"
        sleep 10

        # è‹¥ cloudflared å·²é€€å‡ºåˆ™æ‰“å°æ—¥å¿—å¹¶å¤±è´¥
        if ! pgrep -f "cloudflared tunnel run" > /dev/null; then
          echo "âŒÂ cloudflared exited unexpectedly:"
          cat cloudflared.log
          exit 1
        fi
        echo "âœ…Â Tunnel up â†’ https://${{ secrets.TUNNEL_HOSTNAME }}/"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. æŒ‚èµ·ä¿æŒåœ¨çº¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Keep runner alive
      run: |
        echo "ğŸŒÂ API public URL: https://${{ secrets.TUNNEL_HOSTNAME }}/"
        # è¾“å‡º cloudflared æ—¥å¿—ï¼Œæ–¹ä¾¿æ’éšœ
        tail -F cloudflared.log &
        while true; do sleep 300; done
