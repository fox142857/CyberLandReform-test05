name: ğŸš€ Expose Fileâ€‘Hash API via Cloudflare Tunnel

on:
  schedule:
    - cron: '0 */5 * * *'
  workflow_dispatch:

jobs:
  expose-api:
    runs-on: ubuntu-latest
    env:
      HOSTNAME: ${{ secrets.CLOUDFLARE_HOSTNAME }}
      TUNNEL_ID: ${{ secrets.CLOUDFLARE_TUNNEL_ID }}
      TUNNEL_TOKEN: ${{ secrets.CF_INSTALL_TOKEN }}
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: ğŸš€ Install Python deps
        run: |
          echo "ğŸš€ Upgrading pip and installing FastAPI and dependencies"
          python -m pip install --upgrade pip
          pip install fastapi uvicorn python-multipart

      - name: ğŸ“¦ Install system packages & cloudflared
        run: |
          echo "ğŸ“¦ Updating apt and installing wget, jq"
          sudo apt-get update
          sudo apt-get install -y wget jq
          echo "ğŸ“¦ Downloading cloudflared"
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin/
          cloudflared --version && echo "âœ… cloudflared installed"

      - name: ğŸ› ï¸ Write Cloudflared config
        run: |
          echo "ğŸ› ï¸ Generating ~/.cloudflared/config.yml"
          mkdir -p ~/.cloudflared
          cp .cloudflared/config.yml ~/.cloudflared/config.yml
          echo "âœ… Cloudflared ingress rules set"

      - name: ğŸš€ Start FastAPI in background
        run: |
          echo "ğŸš€ Starting FastAPI server on port 8000"
          nohup python main/file_hash_api_server.py & sleep 5
          echo "âœ… FastAPI should now be running"

      - name: ğŸŒ Run Cloudflare Tunnel
        run: |
          echo "ğŸŒ Launching cloudflared tunnel"
          nohup cloudflared tunnel run --token "${{ env.TUNNEL_TOKEN }}" "${{ env.TUNNEL_ID }}" & sleep 5
          echo "âœ… Tunnel established at https://${{ env.HOSTNAME }}"

      - name: â³ Wait for API health
        run: |
          echo "â³ Checking API health..."
          for i in {1..12}; do
            code=$(curl -s -o /dev/null -w '%{http_code}' https://${{ env.HOSTNAME }}/)
            if [ "$code" = "200" ]; then
              echo "âœ… [/$i] Root path healthy"
              exit 0
            fi
            code=$(curl -s -o /dev/null -w '%{http_code}' https://${{ env.HOSTNAME }}/api/v1/hash/algorithms)
            if [ "$code" = "200" ]; then
              echo "âœ… [/$i] /api/v1/hash/algorithms healthy"
              exit 0
            fi
            echo "ğŸ”„ attempt $i; retrying in 5s"
            sleep 5
          done
          echo "âŒ API failed to become healthy" && exit 1

      - name: ğŸ—‘ï¸ Cancel previous run
        env:
          REPO: ${{ github.repository }}
        run: |
          echo "ğŸ—‘ï¸ Cancelling previous workflow run (if any)"
          PREV=$(curl -s \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            "https://api.github.com/repos/$REPO/actions/workflows/${{ github.workflow }}/runs?per_page=2" \
            | jq -r '.workflow_runs[1].id')
          if [ "$PREV" != "null" ]; then
            curl -X POST -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
                 "https://api.github.com/repos/$REPO/actions/runs/$PREV/cancel" \
              && echo "âœ… Previous run cancelled"
          else
            echo "âš ï¸ No previous run to cancel"
          fi

      - name: ğŸ™Œ Keep runner alive
        run: |
          echo "ğŸ™Œ Runner up at https://${{ env.HOSTNAME }} â€” sleeping to keep alive"
          while true; do sleep 60; done
