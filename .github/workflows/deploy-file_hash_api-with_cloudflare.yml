name: Expose API via Cloudflare Tunnel (TOKENÂ mode)

on:
  schedule:
    - cron: '0 */5 * * *'   # æ¯ 5Â å°æ—¶åˆ·æ–°
  workflow_dispatch:

concurrency:
  group: cloudflareâ€‘tunnel
  cancel-in-progress: true

jobs:
  expose-api:
    runs-on: ubuntu-latest

    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. ä»£ç  & ä¾èµ– â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - uses: actions/checkout@v3

    - uses: actions/setup-python@v4
      with: { python-version: '3.11' }

    - name: Install deps
      run: |
        python -m pip install -U pip
        pip install fastapi uvicorn python-multipart

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. å¯åŠ¨ FastAPIï¼ˆè„šæœ¬è‡ªå¸¦ PYTHONPATHï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Start API server
      run: |
        nohup python main/file_hash_api_server.py &

        echo "â³ wait apiâ€¦"
        for i in {1..10}; do
          if curl -fs http://localhost:8000/ | grep -q æ–‡ä»¶å“ˆå¸Œè®¡ç®—æœåŠ¡API; then
            echo "âœ… local api ok"; break; fi
          sleep 3
          [ $i -eq 10 ] && { echo "âŒ api fail"; exit 1; }
        done

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. å®‰è£… cloudflared â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Install cloudflared
      run: |
        wget -qO cloudflared \
          https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared && sudo mv cloudflared /usr/local/bin/

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. å¯åŠ¨éš§é“ (TOKEN) â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Run Cloudflare Tunnel
      env: { RAW_TOKEN: ${{ secrets.CF_TUNNEL_TOKEN }} }
      run: |
        TOKEN=$(echo "$RAW_TOKEN" | tr -d '\r\n' | xargs)
        [ -z "$TOKEN" ] && { echo "âŒ empty token"; exit 1; }

        nohup cloudflared tunnel run --no-autoupdate \
              --token "$TOKEN" > cloudflared.log 2>&1 &

        sleep 10
        pgrep -f "cloudflared tunnel run" \
          || { echo "âŒ cloudflared exited"; cat cloudflared.log; exit 1; }
        echo "âœ… tunnel up â†’ https://${{ secrets.TUNNEL_HOSTNAME }}/"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5. ä¿æŒåœ¨çº¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Keep alive
      run: |
        echo "ğŸŒ api url: https://${{ secrets.TUNNEL_HOSTNAME }}/"
        tail -F cloudflared.log &
        while sleep 300; do :; done
