name: Expose API via Cloudflare Tunnel (token mode)

on:
  schedule:
    # ‑ 每 5 小时自动重启一次，绕过 GitHub runner 最长 6h 限制
    - cron: '0 */5 * * *'
  workflow_dispatch:

concurrency:
  group: cloudflare‑tunnel
  cancel-in-progress: true

jobs:
  expose-api:
    runs-on: ubuntu-latest

    steps:
    # ─────────────────────────────────────────────────────────────
    # 1. 获取代码 & Python 依赖
    # ─────────────────────────────────────────────────────────────
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'           # 可改成 3.9+

    - name: Install Python dependencies
      run: |
        python -m pip install -U pip
        pip install fastapi uvicorn python-multipart

    # ─────────────────────────────────────────────────────────────
    # 2. 启动 FastAPI（后台）
    # ─────────────────────────────────────────────────────────────
    - name: Start API server
      run: |
        nohup python main/file_hash_api_server.py &
        echo "⏳ Waiting for API server to boot…"
        sleep 5

    # ─────────────────────────────────────────────────────────────
    # 3. 安装 cloudflared（Linux 版）
    # ─────────────────────────────────────────────────────────────
    - name: Download cloudflared
      run: |
        wget -qO cloudflared \
             https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared
        sudo mv cloudflared /usr/local/bin/

    # ─────────────────────────────────────────────────────────────
    # 4. 使用 **TOKEN 模式** 启动隧道
    # ─────────────────────────────────────────────────────────────
    - name: Run Cloudflare Tunnel
      env:
        CF_TUNNEL_TOKEN: ${{ secrets.CF_TUNNEL_TOKEN }}
      run: |
        nohup cloudflared tunnel run \
              --no-autoupdate \
              --token "$CF_TUNNEL_TOKEN" \
              > cloudflared.log 2>&1 &
        echo "⏳ Waiting for Cloudflare Tunnel to establish…"
        sleep 15
        echo "✅ Tunnel established. Public URL → ${{ secrets.TUNNEL_HOSTNAME }}"

    # ─────────────────────────────────────────────────────────────
    # 5. 保持 runner 存活
    # ─────────────────────────────────────────────────────────────
    - name: Keep job alive
      run: |
        echo "🌐 API available at: https://${{ secrets.TUNNEL_HOSTNAME }}/"
        tail -F cloudflared.log &
        while true; do sleep 300; done
